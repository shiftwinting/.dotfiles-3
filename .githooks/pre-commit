#!/usr/bin/env python3

import os
import subprocess
import sys
from pathlib import Path

import magic


def format_shell_scripts(shell_scripts):
	if shell_scripts:
		subprocess.call(["shfmt", "-w", "-s"] + shell_scripts)


def format_python_scripts(python_scripts):
	if python_scripts:
		subprocess.call(["isort"] + python_scripts)
		subprocess.call(["black"] + python_scripts)

	for script in python_scripts:
		unexpanded_script = subprocess.check_output(
			["unexpand", "--first-only", "-t4", script], text=True
		)

		Path(script).write_text(unexpanded_script)


def main():
	shell_scripts = []
	python_scripts = []

	root_directory = subprocess.check_output(
		["git", "rev-parse", "--show-toplevel"], text=True
	).strip()

	git_status_output = subprocess.check_output(
		["git", "status", "--porcelain"], text=True
	).strip()

	if not git_status_output:
		sys.exit()

	changed_files_relative = [
		i.split()[1] for i in git_status_output.split("\n") if i.split()[0] != "D"
	]

	changed_files = [os.path.join(root_directory, i) for i in changed_files_relative]

	for changed_file in changed_files:
		filetype = magic.detect_from_filename(changed_file).name.lower()

		if "shell" in filetype:
			shell_scripts.append(changed_file)
		elif "python" in filetype:
			python_scripts.append(changed_file)

	format_shell_scripts(shell_scripts)
	format_python_scripts(python_scripts)

	subprocess.call(["git", "add", "-A"])


if __name__ == "__main__":
	main()
